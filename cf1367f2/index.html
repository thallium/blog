<!doctype html><html lang=en><head><meta charset=utf-8><title>Tutorial for Codeforces 1367F2 - Flying Sort (Hard Version)</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.tgc-thallium.com/index.xml title="Thallium's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tutorial for Codeforces 1367F2 - Flying Sort (Hard Version)"><meta name=twitter:description content="Don&rsquo;t be intimidated by the official solution."><link rel=stylesheet href=https://blog.tgc-thallium.com/fontawesome/css/all.min.css><link rel=stylesheet href=https://blog.tgc-thallium.com/css/main.css><link id=dark-mode-theme rel=stylesheet href=https://blog.tgc-thallium.com/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.tgc-thallium.com/js/main.bundle.js></script><script src=https://blog.tgc-thallium.com/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.83.1"></head><body><header><nav class=navbar><div class=nav><p class=lang><i class="fas fa-globe"></i>
<a href=https://blog.tgc-thallium.com/zh-hans/cf1367f2/ title=translated>中文</a></p><ul class=nav-links><li><a href=/ id=Home title=Home><em class="fas fa-home fa-lg"></em></a></li><li><a href=/about/ id=About title=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags/ id=Tags title=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/categories/ id=Categories title=Categories><em class="fas fa-list fa-lg"></em></a></li><li><a href=/archives/ id=Archives title=Archives><em class="fas fa-archive fa-lg"></em></a></li><li><a href=/search/ id=Search title=Search><em class="fas fa-search fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=post-heading><h1>Tutorial for Codeforces 1367F2 - Flying Sort (Hard Version)</h1><span class=meta-post><em class="fa fa-calendar-alt"></em>&nbsp;Jun 18, 2020
&nbsp;&nbsp;&nbsp;<em class="fa fa-folder-open"></em>&nbsp;
<a href=https://blog.tgc-thallium.com/categories/solutions/>Solutions</a>&nbsp;</span></div></div></div></header><div class=container role=main><article class=article class=blog-post><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/katex.min.css integrity=sha384-L+Gq2Cso/Y2x8fX4wausgiZT8z0QPZz7OqPuz4YqAycQJyrJT9NRLpjFBD6zlOia crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/katex.min.js integrity=sha384-z64WtjpyrKFsxox9eI4SI8eM9toXdoYeWb5Qh+8PO+eG54Bv9BZqf9xNhlcLf/sA crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}],throwOnError:!1})})</script><p>Don&rsquo;t be intimidated by the official solution.</p><h2 id=solution>Solution</h2><p>First let&rsquo;s introduce &ldquo;sorted subsequence&rdquo;: a sorted subsequence is a subsequence that is a subarray of the sorted array. It&rsquo;s easy to see that the unmoved elements form a sorted subsequence. So if we find the longest sorted subsequence, the answer is minimized.</p><p>Since we only care about the relative order of numbers, we can compress the number which makes it easier to program. Then for each number we make an array storing all the indices of this number.</p><p>Now let&rsquo;s iterate over each number. If the smallest index of the current number is greater than the biggest index of the previous number, we can simply add all the index to our subsequence. Otherwise, we need to start a new subsequence. There are two things we should notice:</p><ol><li><p>Part of the indices of the current number can be added to the old subsequence. E.g. <code>1,2,1,1,2</code>, the second 2 can be added so we have <code>1,1,1,2</code>.</p></li><li><p>The new subsequence can also include part of the indices of the previous number. E.g. <code>1,2,2,1,2</code> we can add the first 1 to the front so we have <code>1,2,2,2</code>.</p></li></ol><p>There is one special case: the subsequence consists indices of two numbers and indices of both numbers are incomplete. E.g. <code>2,1,1,2,2,1</code>, it&rsquo;s easy to see that we need a prefix of the fist number the a suffix of the second number. So we can iterate over each prefix of the first number and find the corresponding suffix of the second number.</p><h2 id=code>Code</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;bits/stdc++.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define forn(i, n) for (int i = 0; i &lt; int(n); ++i)
</span><span style=color:#75715e>#define all(x) (x).begin(),(x).end()
</span><span style=color:#75715e>#define size(x) int(x.size())
</span><span style=color:#75715e>#define pb push_back
</span><span style=color:#75715e></span>
<span style=color:#00a8c8>using</span> <span style=color:#00a8c8>namespace</span> <span style=color:#111>std</span><span style=color:#111>;</span>
<span style=color:#00a8c8>using</span> <span style=color:#111>ll</span><span style=color:#f92672>=</span><span style=color:#00a8c8>long</span> <span style=color:#00a8c8>long</span><span style=color:#111>;</span>

<span style=color:#00a8c8>int</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
    <span style=color:#111>ios</span><span style=color:#f92672>::</span><span style=color:#111>sync_with_stdio</span><span style=color:#111>(</span><span style=color:#111>false</span><span style=color:#111>);</span>
    <span style=color:#111>cin</span><span style=color:#111>.</span><span style=color:#111>tie</span><span style=color:#111>(</span><span style=color:#00a8c8>nullptr</span><span style=color:#111>);</span>
    <span style=color:#00a8c8>int</span> <span style=color:#111>tt</span><span style=color:#111>;</span>
    <span style=color:#111>cin</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#111>tt</span><span style=color:#111>;</span>
    <span style=color:#111>for1</span><span style=color:#111>(</span><span style=color:#111>T</span><span style=color:#111>,</span><span style=color:#111>tt</span><span style=color:#111>){</span>
        <span style=color:#00a8c8>int</span> <span style=color:#111>n</span><span style=color:#111>;</span>
        <span style=color:#111>cin</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#111>n</span><span style=color:#111>;</span>
        <span style=color:#111>vector</span><span style=color:#f92672>&lt;</span><span style=color:#00a8c8>int</span><span style=color:#f92672>&gt;</span> <span style=color:#111>a</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>),</span><span style=color:#111>d</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>);</span>
        <span style=color:#111>forn</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>,</span><span style=color:#111>n</span><span style=color:#111>){</span>
            <span style=color:#111>cin</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
            <span style=color:#111>d</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
        <span style=color:#111>}</span>
        <span style=color:#75715e>//coord compression 
</span><span style=color:#75715e></span>        <span style=color:#111>sort</span><span style=color:#111>(</span><span style=color:#111>all</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#111>));</span>
        <span style=color:#111>d</span><span style=color:#111>.</span><span style=color:#111>resize</span><span style=color:#111>(</span><span style=color:#111>unique</span><span style=color:#111>(</span><span style=color:#111>all</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#111>))</span><span style=color:#f92672>-</span><span style=color:#111>d</span><span style=color:#111>.</span><span style=color:#111>begin</span><span style=color:#111>());</span>
        <span style=color:#111>vector</span><span style=color:#f92672>&lt;</span><span style=color:#111>vector</span><span style=color:#f92672>&lt;</span><span style=color:#00a8c8>int</span><span style=color:#f92672>&gt;&gt;</span> <span style=color:#111>pos</span><span style=color:#111>(</span><span style=color:#111>size</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#111>));</span>
        <span style=color:#111>forn</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>,</span><span style=color:#111>n</span><span style=color:#111>){</span>
            <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#111>lower_bound</span><span style=color:#111>(</span><span style=color:#111>all</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#111>),</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>])</span><span style=color:#f92672>-</span><span style=color:#111>d</span><span style=color:#111>.</span><span style=color:#111>begin</span><span style=color:#111>();</span>
            <span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]].</span><span style=color:#111>push_back</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>);</span>
        <span style=color:#111>}</span>

        <span style=color:#00a8c8>int</span> <span style=color:#111>r</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span><span style=color:#111>mxlen</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#111>curlen</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>;</span>
        <span style=color:#111>forn</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>,</span><span style=color:#111>size</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#111>)){</span>
            <span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>][</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>&gt;</span><span style=color:#111>r</span><span style=color:#111>){</span>
                <span style=color:#111>curlen</span><span style=color:#f92672>+=</span><span style=color:#111>size</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]);</span>
            <span style=color:#111>}</span><span style=color:#00a8c8>else</span><span style=color:#111>{</span>
                <span style=color:#75715e>//extend to the right for the old sequence
</span><span style=color:#75715e></span>                <span style=color:#00a8c8>auto</span> <span style=color:#111>j</span><span style=color:#f92672>=</span><span style=color:#111>lower_bound</span><span style=color:#111>(</span><span style=color:#111>all</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]),</span><span style=color:#111>r</span><span style=color:#111>);</span>
                <span style=color:#111>mxlen</span><span style=color:#f92672>=</span><span style=color:#111>max</span><span style=color:#111>(</span><span style=color:#111>mxlen</span><span style=color:#111>,</span><span style=color:#111>curlen</span><span style=color:#f92672>+</span><span style=color:#00a8c8>int</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>].</span><span style=color:#111>end</span><span style=color:#111>()</span><span style=color:#f92672>-</span><span style=color:#111>j</span><span style=color:#111>));</span>
                <span style=color:#75715e>//extend to the left for the new sequence
</span><span style=color:#75715e></span>                <span style=color:#00a8c8>auto</span> <span style=color:#111>it</span><span style=color:#f92672>=</span><span style=color:#111>lower_bound</span><span style=color:#111>(</span><span style=color:#111>all</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]),</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>][</span><span style=color:#ae81ff>0</span><span style=color:#111>]);</span>
                <span style=color:#111>curlen</span><span style=color:#f92672>=</span><span style=color:#00a8c8>int</span><span style=color:#111>(</span><span style=color:#111>it</span><span style=color:#f92672>-</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>].</span><span style=color:#111>begin</span><span style=color:#111>())</span><span style=color:#f92672>+</span><span style=color:#111>size</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]);</span>
            <span style=color:#111>}</span>
            <span style=color:#111>mxlen</span><span style=color:#f92672>=</span><span style=color:#111>max</span><span style=color:#111>(</span><span style=color:#111>mxlen</span><span style=color:#111>,</span><span style=color:#111>curlen</span><span style=color:#111>);</span>
            <span style=color:#111>r</span><span style=color:#f92672>=</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>].</span><span style=color:#111>back</span><span style=color:#111>();</span>
        <span style=color:#111>}</span>
        <span style=color:#75715e>//check the special case: sequence containing only two numbers
</span><span style=color:#75715e></span>        <span style=color:#111>forn</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>,</span><span style=color:#111>size</span><span style=color:#111>(</span><span style=color:#111>d</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>){</span>
            <span style=color:#111>forn</span><span style=color:#111>(</span><span style=color:#111>j</span><span style=color:#111>,</span><span style=color:#111>size</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>])){</span>
                <span style=color:#00a8c8>auto</span> <span style=color:#111>it</span><span style=color:#f92672>=</span><span style=color:#111>lower_bound</span><span style=color:#111>(</span><span style=color:#111>all</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>]),</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>][</span><span style=color:#111>j</span><span style=color:#111>]);</span>
                <span style=color:#111>mxlen</span><span style=color:#f92672>=</span><span style=color:#111>max</span><span style=color:#111>(</span><span style=color:#111>mxlen</span><span style=color:#111>,</span><span style=color:#111>j</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#f92672>+</span><span style=color:#00a8c8>int</span><span style=color:#111>(</span><span style=color:#111>pos</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>].</span><span style=color:#111>end</span><span style=color:#111>()</span><span style=color:#f92672>-</span><span style=color:#111>it</span><span style=color:#111>));</span>
            <span style=color:#111>}</span>
        <span style=color:#111>}</span>
        <span style=color:#111>cout</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#111>n</span><span style=color:#f92672>-</span><span style=color:#111>mxlen</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#111>endl</span><span style=color:#111>;</span>
    <span style=color:#111>}</span>
    <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><div class=blog-tags><a href=https://blog.tgc-thallium.com/tags/greedy/>Greedy</a>&nbsp;
<a href=https://blog.tgc-thallium.com/tags/binary-search/>Binary Search</a>&nbsp;</div></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><div id=gitalk-container></div><script>var gitalk=new Gitalk({clientID:'804f53fd87621403bf11',clientSecret:'5cfea89eac0c032eb02b333a1030d73e7b6e2176',repo:'blog',owner:'thallium',admin:['thallium'],id:location.pathname,distractionFreeMode:!1});gitalk.render('gitalk-container')</script></div><footer><div class=social-icons><a href=https://github.com/thallium name=GitHub><em class="fab fa-github"></em></a></div><p>Lang:
<a href=https://blog.tgc-thallium.com/zh-hans/cf1367f2/>中文</a></p><div class=container><p class="credits copyright"><a href=https://blog.tgc-thallium.com/about>Gengchen</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.tgc-thallium.com/>Thallium's Blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>