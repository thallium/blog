<!doctype html><html lang=en><head><meta charset=utf-8><title>Solution for CodeForces 1313C2 - Skyscrapers (hard version)</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.tgc-thallium.com/index.xml title="Thallium's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Solution for CodeForces 1313C2 - Skyscrapers (hard version)"><meta name=twitter:description content="Time to learn monotone stack."><link rel=stylesheet href=https://blog.tgc-thallium.com/fontawesome/css/all.min.css><link rel=stylesheet href=https://blog.tgc-thallium.com/css/main.css><link id=dark-mode-theme rel=stylesheet href=https://blog.tgc-thallium.com/css/dark.css><script>var darkTheme=document.getElementById('dark-mode-theme'),storedTheme=localStorage.getItem('dark-mode-storage');storedTheme==='dark'?darkTheme.disabled=!1:storedTheme==='light'&&(darkTheme.disabled=!0)</script><script src=https://blog.tgc-thallium.com/js/main.bundle.js></script><script src=https://blog.tgc-thallium.com/js/instantpage.min.js type=module defer></script><meta name=generator content="Hugo 0.83.1"></head><body><header><nav class=navbar><div class=nav><p class=lang><i class="fas fa-globe"></i>
<a href=https://blog.tgc-thallium.com/zh-hans/ title="no translation">中文</a></p><ul class=nav-links><li><a href=/ id=Home title=Home><em class="fas fa-home fa-lg"></em></a></li><li><a href=/about/ id=About title=About><em class="fas fa-user fa-lg"></em></a></li><li><a href=/tags/ id=Tags title=Tags><em class="fas fa-tag fa-lg"></em></a></li><li><a href=/categories/ id=Categories title=Categories><em class="fas fa-list fa-lg"></em></a></li><li><a href=/archives/ id=Archives title=Archives><em class="fas fa-archive fa-lg"></em></a></li><li><a href=/search/ id=Search title=Search><em class="fas fa-search fa-lg"></em></a></li></ul></div></nav><div class=intro-header><div class=container><div class=post-heading><h1>Solution for CodeForces 1313C2 - Skyscrapers (hard version)</h1><span class=meta-post><em class="fa fa-calendar-alt"></em>&nbsp;Feb 25, 2020
&nbsp;&nbsp;&nbsp;<em class="fa fa-folder-open"></em>&nbsp;
<a href=https://blog.tgc-thallium.com/categories/solutions/>Solutions</a>&nbsp;</span></div></div></div></header><div class=container role=main><article class=article class=blog-post><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/katex.min.css integrity=sha384-L+Gq2Cso/Y2x8fX4wausgiZT8z0QPZz7OqPuz4YqAycQJyrJT9NRLpjFBD6zlOia crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/katex.min.js integrity=sha384-z64WtjpyrKFsxox9eI4SI8eM9toXdoYeWb5Qh+8PO+eG54Bv9BZqf9xNhlcLf/sA crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.5/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:!0},{left:'$',right:'$',display:!1},{left:'\\(',right:'\\)',display:!1},{left:'\\[',right:'\\]',display:!0}],throwOnError:!1})})</script><aside><nav id=TableOfContents><ul><li><a href=#solution>Solution</a></li><li><a href=#code>Code</a></li></ul></nav></aside><p>Time to learn monotone stack.</p><h2 id=solution>Solution</h2><p>It&rsquo;s quite obvious that the answer goes non-decreasing from the start and at some point turns to non-increasing. We want to find the optimal turning point.</p><p>We can build two arrays $pre$ and $suf$ of length n. The ith element of $pre$ represents the maximum sum of floors from 1 to i if the floors are non-decreasing. Similar definition for $suf$. The turning point t is where $pre_t+suf_t-m_t$ is maximum.</p><p>For example: let $m={1,2,3,2,1}$</p><table><thead><tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th></tr></thead><tbody><tr><td>pre</td><td>1</td><td>3</td><td>6</td><td>7</td><td>5</td></tr><tr><td>suf</td><td>5</td><td>7</td><td>6</td><td>3</td><td>1</td></tr><tr><td>m</td><td>1</td><td>2</td><td>3</td><td>2</td><td>1</td></tr><tr><td>pre+suf-m</td><td>5</td><td>8</td><td>9</td><td>8</td><td>5</td></tr></tbody></table><p>We can build the arrays by maintaining a mono-increasing stack <code>stack&lt;pair&lt;ll,ll>></code> to find the rightest number smaller than <code>m_i</code>. The second element is the number of floors and first element is the number of buildings with the same height. You will understand it better in the detailed buildings process of $pre$:</p><p><strong>i=0</strong></p><p>nothing in the stack.</p><p><code>pre[0]+=1</code></p><p>Push<code>{1,1}</code> to the stack and now the stack:<code>{{1,1}}</code></p><p><strong>i=1</strong></p><p>First set <code>pre[1]=pre[0]</code></p><p>Since <code>m[1]>stack.top().second</code>, no pop.</p><p><code>pre[1]+=m[1]</code></p><p>now $pre_1=3$</p><p>Push {1,2} to the stack and the stack is now:<code>{{1,1},{1,2}}</code></p><p><strong>i=2</strong></p><p>Similar to i=1.</p><p><code>pre[2]=6</code></p><p><code>{{1,1},{1,2},{1,3}}</code></p><p><strong>i=3</strong></p><p><code>m[3]&lt;stack.top().second</code> which means that we need to change the height of previous buildings to keep the monotonicity. Keep popping out the bigger element and <code>{1,3}</code> is popped. The <code>pre[3]</code> should be decreased by 1*3 and is 3 now. Then the height of 2,3 should be 2 and <code>pre[3]+=2*2</code>. Finally we push <code>{2,2}</code> to the stack.</p><p><strong>i=4</strong></p><p>Similarly, we pop out <code>{2,2}</code> and <code>{1,2}</code> and <code>pre[4]-=2*2+1*2</code> and now <code>pre[4]=1</code>. Then the height of 1,2,3,4 should be 1 and <code>pre[4]+=4*1</code>. Finally push <code>{4,1}</code> to the stack.</p><p>We could build $suf$ in the similar way but go from right to left.</p><h2 id=code>Code</h2><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;bits/stdc++.h&gt;</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
<span style=color:#75715e>#define forn(i, n) for (int i = 0; i &lt; int(n); ++i)
</span><span style=color:#75715e>#define ford(i, n) for (int i = int(n)-1; i &gt;= 0; --i)
</span><span style=color:#75715e>#define F first
</span><span style=color:#75715e>#define S second
</span><span style=color:#75715e></span>
<span style=color:#00a8c8>using</span> <span style=color:#00a8c8>namespace</span> <span style=color:#111>std</span><span style=color:#111>;</span>
<span style=color:#00a8c8>typedef</span> <span style=color:#00a8c8>long</span> <span style=color:#00a8c8>long</span> <span style=color:#111>ll</span><span style=color:#111>;</span>

<span style=color:#00a8c8>int</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
	<span style=color:#111>ios</span><span style=color:#f92672>::</span><span style=color:#111>sync_with_stdio</span><span style=color:#111>(</span><span style=color:#111>false</span><span style=color:#111>);</span>
	<span style=color:#111>cin</span><span style=color:#111>.</span><span style=color:#111>tie</span><span style=color:#111>(</span><span style=color:#00a8c8>nullptr</span><span style=color:#111>);</span>
	<span style=color:#00a8c8>int</span> <span style=color:#111>n</span><span style=color:#111>;</span>
	<span style=color:#111>cin</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#111>n</span><span style=color:#111>;</span>
	<span style=color:#111>vector</span><span style=color:#f92672>&lt;</span><span style=color:#111>ll</span><span style=color:#f92672>&gt;</span> <span style=color:#111>a</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>);</span>
	<span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#00a8c8>auto</span><span style=color:#f92672>&amp;</span> <span style=color:#111>it</span><span style=color:#111>:</span><span style=color:#111>a</span><span style=color:#111>)</span> <span style=color:#111>cin</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#111>it</span><span style=color:#111>;</span>
	<span style=color:#111>vector</span><span style=color:#f92672>&lt;</span><span style=color:#111>ll</span><span style=color:#f92672>&gt;</span> <span style=color:#111>pre</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>),</span><span style=color:#111>suf</span><span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#111>);</span>
	<span style=color:#111>stack</span><span style=color:#f92672>&lt;</span><span style=color:#111>pair</span><span style=color:#f92672>&lt;</span><span style=color:#111>ll</span><span style=color:#111>,</span><span style=color:#111>ll</span><span style=color:#f92672>&gt;&gt;</span> <span style=color:#111>stk</span><span style=color:#111>;</span>
	<span style=color:#111>forn</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>,</span><span style=color:#111>n</span><span style=color:#111>){</span>
		<span style=color:#00a8c8>int</span> <span style=color:#111>now</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#111>;</span>
		<span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>)</span> <span style=color:#111>pre</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#111>pre</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
		<span style=color:#00a8c8>while</span><span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>empty</span><span style=color:#111>()</span><span style=color:#f92672>&amp;&amp;</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>S</span><span style=color:#f92672>&gt;</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]){</span>
			<span style=color:#111>now</span><span style=color:#f92672>+=</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>F</span><span style=color:#111>;</span>
			<span style=color:#111>pre</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>-=</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>F</span><span style=color:#f92672>*</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>S</span><span style=color:#111>;</span>
			<span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>pop</span><span style=color:#111>();</span>
		<span style=color:#111>}</span>
		<span style=color:#111>pre</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>+=</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#111>now</span><span style=color:#111>;</span>
		<span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>push</span><span style=color:#111>({</span><span style=color:#111>now</span><span style=color:#111>,</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]});</span>
	<span style=color:#111>}</span>
	<span style=color:#111>stk</span><span style=color:#f92672>=</span><span style=color:#111>stack</span><span style=color:#f92672>&lt;</span><span style=color:#111>pair</span><span style=color:#f92672>&lt;</span><span style=color:#111>ll</span><span style=color:#111>,</span><span style=color:#111>ll</span><span style=color:#f92672>&gt;&gt;</span><span style=color:#111>();</span>
	<span style=color:#111>ford</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>,</span><span style=color:#111>n</span><span style=color:#111>){</span>
		<span style=color:#00a8c8>int</span> <span style=color:#111>now</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#111>;</span>
		<span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#f92672>!=</span><span style=color:#111>n</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>suf</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#111>suf</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>];</span>
		<span style=color:#00a8c8>while</span><span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>empty</span><span style=color:#111>()</span><span style=color:#f92672>&amp;&amp;</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>S</span><span style=color:#f92672>&gt;</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]){</span>
			<span style=color:#111>now</span><span style=color:#f92672>+=</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>F</span><span style=color:#111>;</span>
			<span style=color:#111>suf</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>-=</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>F</span><span style=color:#f92672>*</span><span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>top</span><span style=color:#111>().</span><span style=color:#111>S</span><span style=color:#111>;</span>
			<span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>pop</span><span style=color:#111>();</span>
		<span style=color:#111>}</span>
		<span style=color:#111>suf</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>+=</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>*</span><span style=color:#111>now</span><span style=color:#111>;</span>
		<span style=color:#111>stk</span><span style=color:#111>.</span><span style=color:#111>push</span><span style=color:#111>({</span><span style=color:#111>now</span><span style=color:#111>,</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]});</span>
	<span style=color:#111>}</span>
	<span style=color:#111>ll</span> <span style=color:#111>mx</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span><span style=color:#111>pos</span><span style=color:#111>;</span>
	<span style=color:#111>forn</span><span style=color:#111>(</span><span style=color:#111>i</span><span style=color:#111>,</span><span style=color:#111>n</span><span style=color:#111>){</span>
		<span style=color:#00a8c8>if</span><span style=color:#111>(</span><span style=color:#111>pre</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>+</span><span style=color:#111>suf</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>&gt;</span><span style=color:#111>mx</span><span style=color:#111>){</span>
			<span style=color:#111>mx</span><span style=color:#f92672>=</span><span style=color:#111>pre</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>+</span><span style=color:#111>suf</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>-</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
			<span style=color:#111>pos</span><span style=color:#f92672>=</span><span style=color:#111>i</span><span style=color:#111>;</span>
		<span style=color:#111>}</span>
	<span style=color:#111>}</span>
	<span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span><span style=color:#f92672>=</span><span style=color:#111>pos</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>;</span><span style=color:#111>i</span><span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>0</span><span style=color:#111>;</span><span style=color:#111>i</span><span style=color:#f92672>--</span><span style=color:#111>){</span>
		<span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]);</span>
	<span style=color:#111>}</span>
	<span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>i</span><span style=color:#f92672>=</span><span style=color:#111>pos</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>;</span><span style=color:#111>i</span><span style=color:#f92672>&lt;</span><span style=color:#111>n</span><span style=color:#111>;</span><span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span><span style=color:#f92672>=</span><span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span><span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]);</span>
	<span style=color:#00a8c8>for</span><span style=color:#111>(</span><span style=color:#00a8c8>auto</span> <span style=color:#111>it</span><span style=color:#111>:</span><span style=color:#111>a</span><span style=color:#111>)</span> <span style=color:#111>cout</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#111>it</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#d88200>&#39; &#39;</span><span style=color:#111>;</span>
	<span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
<span style=color:#111>}</span>
</code></pre></div><div class=blog-tags><a href=https://blog.tgc-thallium.com/tags/data-structure/>Data Structure</a>&nbsp;
<a href=https://blog.tgc-thallium.com/tags/monotonic-stack/>Monotonic Stack</a>&nbsp;</div></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><div id=gitalk-container></div><script>var gitalk=new Gitalk({clientID:'804f53fd87621403bf11',clientSecret:'5cfea89eac0c032eb02b333a1030d73e7b6e2176',repo:'blog',owner:'thallium',admin:['thallium'],id:location.pathname,distractionFreeMode:!1});gitalk.render('gitalk-container')</script></div><footer><div class=social-icons><a href=https://github.com/thallium name=GitHub><em class="fab fa-github"></em></a></div><div class=container><p class="credits copyright"><a href=https://blog.tgc-thallium.com/about>Gengchen</a>
&nbsp;&copy;
2021
&nbsp;/&nbsp;
<a href=https://blog.tgc-thallium.com/>Thallium's Blog</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>